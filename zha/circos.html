<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <style>
      #chart {
        position: fixed;
        left: 0px;
        right: 0px;
        top: 0px;
        bottom: 0px;
        z-index: -2;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div id="chart">
    </div>
    <script>
      var chartDiv = document.getElementById("chart");
      var width = chartDiv.clientWidth -20;
      var height = chartDiv.clientHeight -20;

      var x = d3.scaleLinear().range([0,height*1.5]).domain([0,1000])
      var y = d3.scaleLinear().range([0,height]).domain([1000,0])
      var mm10chr = ['chr1','chr2','chr3','chr4','chr5','chr6','chr7','chr8','chr9','chr10','chr11','chr12','chr13','chr14','chr15','chr16','chr17','chr18','chr19','chrX','chrY',' chrP','chrR']
      var scale = d3.scaleLinear().range([0,height]).domain([0,1000])

      var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height)

      var pie = d3.pie()
          .sort(null)
          .padAngle(0.01)
          .value(function(d) { return d.length; });

      var donut = svg.append("g")
        .attr("transform", "translate(" + x(500) + "," + y(500) + ")")
        .attr('class','donut')

      // function to generate initial circle
      var buildDonut = function(input, callback){
        d3.tsv(input, function(error,data){
          if (error) throw error;

          var arc_chr = d3.arc()
              .outerRadius(scale(300))
              .innerRadius(scale(200));

          var pieArray = pie(data);
          var g = donut.selectAll(".arc_chr")
              .data(pieArray)
            .enter().append("g")
              .attr("class", "arc_chr")
          g.append("path")
            .attr('d',arc_chr)
            .style('fill','dodgerblue')
          //callback to next in queue, return with pieArray
          callback(null, pieArray)
        })
      }

      //build donut, use angles to generate histograms
      d3.queue()
        .defer(buildDonut,"mm10prChrLen.txt")
        .await(function(error, pieArray){
          if (error) throw error;
          d3.tsv("XR4P24.txt", function(error,data){
            //console.log(data)
            for (var i in pieArray){
              var binSize = 2500000
              var binNum = Math.floor(pieArray[i].data.length / binSize)
              var bins = Array.apply(null, Array(binNum)).map(Number.prototype.valueOf,0)
              console.log(mm10chr[i])
              var translocEvents = data.filter(function(item){
                return item.Rname==mm10chr[i]
              })
              for (var j in translocEvents){
                bins[Math.floor(translocEvents[j].Junction/binSize)] = bins[Math.floor(translocEvents[j].Junction/binSize)] + 5
              }
              var arc_hist = d3.arc()
                .outerRadius(function(d){return scale(300) + scale(d.data)})
                .innerRadius(scale(300));
              var histogram = d3.pie()
                  .sort(null)
                  .startAngle(pieArray[i].startAngle + 0.006)
                  .endAngle(pieArray[i].endAngle - 0.006)
                  .value(function(d) { return binSize });
              var h = donut.selectAll()
                  .data(histogram(bins))
                .enter().append("g")
                  .attr("class","arc_hist")
              h.append("path")
                .attr("d", arc_hist)
                .style("fill","black")
            }
          })
        })
    </script>
  </body>
</html>
