<!DOCTYPE html>
<html>    
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.css">
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
    <style>
        #chart {
            position: fixed;
            left: 0px;
            right: 0px;
            top: 0px;
            bottom: 0px;
            z-index: -2;
            height: 100%;
        }
        #options{
            margin-bottom:10px; 
            border-radius: 5px;
            padding: 10px;
            background-color: #FFEFD5;
        }
        body {
            font-family: sans-serif
        }
        div.tooltip {
            position: absolute;
            text-align: left;
            width: auto;
            height: auto;
            padding: 5px;
            border-width: 1px;
            border-radius: 2px;
            pointer-events: none;
            font-family: sans-serif;
            font-size: 13px;
            border: 2px solid white;
        }
        input{
            margin-bottom: 0.5rem;
            height: 25px !important;
        }
        button{
            padding-left: 10px;
            padding-right: 10px;
            background-color: white;
        }
    
    </style>
  </head>
  <body>
    <div id="options" class="row">
        <div class="three columns">
            <div class="row">
                <b>Add Gene:</b>
                <br>
                <input list="addGeneList" placeholder="e.g. TP53" id='addGeneInput'>
                <datalist id="addGeneList">
                </datalist>
                <button type="button" id="addGeneButton">Add</button>
            </div>
            <div id='no_variants_error' style="font-size:10px; color:red; opacity:0">No variants found for this gene.</div>
        </div>
        <div class="three columns">
            <div class="row">
                <b>Group by:</b>
                <br>
                <select id="groupByList">
                </select>
                <br>
                <b>Sort by:</b>
                <br>
                <select id="sortByList">
                    <option value="max">Max score</option>
                    <option value="avg">Average score</option>
                </select>
            </div>
        </div>
        <div class="four columns">
            <div><b>Adjust CNV Thresholds:</b></div>
            <div style="padding-left: 20px" class="row">
                <div class="four columns">HIGH AMP:</div> 
                <input class="four columns" type="number" id="high_amp_adjust" value=2 step=".01"></div>
            <div style="padding-left: 20px" class="row">
                <div class="four columns">AMP:</div>  
                <input class="four columns" type="number" id="amp_adjust" value=1 step=".01"></div>
            <div style="padding-left: 20px" class="row">
                <div class="four columns">DEL:</div>  
                <input class="four columns" type="number" id="del_adjust" value=-1 step=".01"></div>
            <div style="padding-left: 20px" class="row">
                <div class="four columns">DEEP DEL:</div>  
                <input class="four columns" type="number" id="deep_del_adjust" value=-2 step=".01"></div>
            <button type="button" id="readjustThreshold" class="row">Readjust</button>
        </div>
    </div>
    <div id="chart">
    </div>
    
    <script>
        var chartDiv = document.getElementById("chart");
        var width = chartDiv.clientWidth -20;
        var height = chartDiv.clientHeight -20;

        var x = d3.scaleLinear().range([0,width]).domain([0,1000])
        var y = d3.scaleLinear().range([0,height-150]).domain([0,1000])
        var scale = d3.scaleLinear().range([0,height]).domain([0,1000])
        
        var attr = ['HIGH','MODERATE','HIGH AMP','AMP','DEL','DEEP DEL']
        var attrColors = ['black','#f8b946','#982f2f','#f85252','#3573fd','#00308b']
        var colorScale = d3.scaleOrdinal().range(attrColors).domain(attr)
        
        var ampColorScale = d3.scaleLinear().range(['white','#982f2f']).domain([0,1])
        var delColorScale = d3.scaleLinear().range(['white','#00308b']).domain([0,-1])
        
        var div = d3.select("body").append("div")
        .attr("class", "tooltip")
        .attr("font-size",scale(60))
        .style("opacity", 0);

        var svg = d3.select("body").append("svg")
            .attr("width", 3000)
            .attr("height", 4000)
        
        var cellWidth = 20
        var cellHeight = 40
        var cellPadding = 2
        var metadataHeight = 20
        var xAxistextSize = 12
        var yAxistextSize = 15
        var yAxisWidth = 10 //by default. will be changed
        var thresh_highamp = 2
        var thresh_amp = 1
        var thresh_del = -1
        var thresh_deepdel = -2
        
        var groupBy = d3.select('#groupByList')
        var sortBy = d3.select('#sortByList')
        
        function getCNVColor(cnv, ploidy){
            if(cnv != ''){
                if (cnv - ploidy >= thresh_highamp){
                    return colorScale('HIGH AMP')
                } else if (cnv - ploidy >= thresh_amp){
                    return colorScale('AMP')
                } else if (cnv - ploidy <= thresh_deepdel){
                    return colorScale('DEEP DEL')
                } else if (cnv - ploidy <= thresh_del){
                    return colorScale('DEL')
                } else {
                    return 'rgb(0,0,0,0)'
                }
            }
            else{
                return 'rgb(0,0,0,0)'
            }
            
        }
        
        function getVARColor(impact){
            if (impact == "HIGH"){
                return colorScale('HIGH')
            } else if (impact == "MODERATE"){
                return colorScale('MODERATE')
            } else {
                return 'rgb(0,0,0,0)'
            }
        }
        
        function rankSampleSubset(subset, metadata, thresh_ha, thresh_a, thresh_d, thresh_dd, genes){
            score = BigInt(0)
	    multiplier = BigInt(Math.pow(10,genes.length))
            for(i in subset){
                geneRankPos = genes.indexOf(subset[i].Gene)
                subset[i].Ploidy = metadata.filter(function(f){return f.Sample == subset[i].Sample})[0].Ploidy
                if (subset[i].Impact == "MODERATE"){
                    score = score + BigInt(3)*multiplier/BigInt(Math.pow(10,geneRankPos))
                }
                else if (subset[i].Impact == "HIGH"){
                    score = score + BigInt(6)*multiplier/BigInt(Math.pow(10,geneRankPos))
                }
                if (subset[i].CNV != ""){
                    copyNumDiff = subset[i].CNV-subset[i].Ploidy
                    if(copyNumDiff >= thresh_ha){
                        score = score + BigInt(2)*multiplier/BigInt(Math.pow(10,geneRankPos))
                    }
                    else if(copyNumDiff >= thresh_a && copyNumDiff < thresh_ha){
                        score = score + BigInt(1)*multiplier/BigInt(Math.pow(10,geneRankPos))
                    }
                    else if(copyNumDiff <= thresh_dd){
                        score = score + BigInt(2)*multiplier/BigInt(Math.pow(10,geneRankPos))
                    }
                    else if(copyNumDiff <= thresh_d && copyNumDiff > thresh_dd){
                        score = score + BigInt(1)*multiplier/BigInt(Math.pow(10,geneRankPos))
                    }
                }
            }
            return score
        }
        
        function rankGeneSubset(subset, metadata, thresh_ha, thresh_a, thresh_d, thresh_dd, prioritize=false){
            for(i in subset){
                subset[i].Ploidy = metadata.filter(function(f){return f.Sample == subset[i].Sample})[0].Ploidy
            }
            mod_num = subset.filter(function(f){return f.Impact == "MODERATE"}).length
            high_num = subset.filter(function(f){return f.Impact == "HIGH"}).length
            high_amp_num = subset.filter(function(f){return f.CNV-f.Ploidy >= thresh_ha && f.CNV != ""}).length
            amp_num = subset.filter(function(f){return f.CNV-f.Ploidy >= thresh_a && f.CNV-f.Ploidy < thresh_ha && f.CNV != ""}).length
            deep_del_num = subset.filter(function(f){return f.CNV-f.Ploidy <= thresh_dd && f.CNV != ""}).length
            del_num = subset.filter(function(f){return f.CNV-f.Ploidy <= thresh_d && f.CNV-f.Ploidy > thresh_dd && f.CNV != ""}).length

            score = high_num * 20
                + mod_num * 10
                + deep_del_num * 4
                + high_amp_num * 4
                + del_num * 2
                + amp_num * 2
            
            return score
        }
        
        function rankSamples(samples, data, metadata, genes){
            //console.log(metadata)
            sampleRankList = []
            for (i in samples){
                sampleData = data.filter(function(f){
                    return f.Sample == samples[i]
                })
                sampleRankList.push({Sample: samples[i], score: rankSampleSubset(sampleData,metadata,thresh_highamp,thresh_amp,thresh_del,thresh_deepdel,genes)})
            }
            sampleRankList.sort(function(a,b){
		if(b.score < a.score){
			return -1
		}
		else{
			return 1
		}
	    })
            console.log(sampleRankList)
            return [...new Set(sampleRankList.map(a => a.Sample))]
        }
        
        function rankGenes(data, geneList, metadata){
            rankList = []
            for (i in geneList){
                
                geneData = data.filter(function(f){
                    return f.Gene == geneList[i]
                })
                rankList.push({gene: geneList[i], score: rankGeneSubset(geneData,metadata,thresh_highamp,thresh_amp,thresh_del,thresh_deepdel)})
            }
            rankList = rankList.filter(function(f){return f.gene != 'Unknown'})
            
            return rankList.sort(function(a,b){return b.score - a.score})
        }
        
        function readjustPos(genes, samples, metaList){
            for(var i in samples){
                //redraw sample label
                d3.selectAll('#' + samples[i] + "_label")
                    //.attr('x', (y(cellWidth) + cellPadding) * i)
                    .attr('transform','rotate(45,' + ((y(cellWidth) + cellPadding) * i + y(yAxisWidth) )+ ',' + y(10)+ ')')
                //redraw sample variants
                d3.selectAll('.' + samples[i])
                    .attr('x', (y(cellWidth) + cellPadding) * i)
            }
            for(var i in genes){
                d3.selectAll('.' + genes[i])
                    .attr('transform', function(d){
                        return 'translate(' + y(yAxisWidth) + ',' + (y(cellHeight) + cellPadding) * i + ')'
                    })
            }
            d3.selectAll('.xaxis')
                .attr('transform', 'translate(0,'+(((y(cellHeight) + cellPadding) * genes.length) + ((y(metadataHeight) + cellPadding) * metaList.length))+")")
            d3.selectAll('.metadata')
                .attr('transform', function(d){
                    return 'translate(' + y(yAxisWidth) + ',' + ((y(cellHeight) + cellPadding) * genes.length) + ')'
                })
        }
        
        function addVariants(data, genes, samples, metadata){
            var variants = svg.append('g').attr('class','variants')
            
            variant = variants.selectAll('.variant')
                .data(data).enter()
                .append('g')
                .attr('transform', function(d){
                    return 'translate(' + y(yAxisWidth) + ',' + (y(cellHeight) + cellPadding) * genes.indexOf(d.Gene) + ')'
                })
                .attr('class', function(d){return d.Gene})

            //draw cnv square
            variant.append('rect')
                .attr('class', function(d){return d.Sample + " CNV COL"})
                .attr('width',y(cellWidth))
                .attr('height',y(cellHeight))
                .attr('fill',function(d){
                    var ploidy = metadata.filter(function(f){return f.Sample == d.Sample})[0].Ploidy
                    return getCNVColor(d.CNV, ploidy)
                })
                .attr('x', function(d){return (y(cellWidth) + cellPadding) * samples.indexOf(d.Sample)})
                .attr('pointer-events', function(d){
                    if (d.CNV != ''){
                        return 'all'
                    }
                    else {
                        return 'none'
                    }
                })
                .on('mouseover', function(d){
                    //console.log(d)
                    div.html(
                        'Gene: ' + d.Gene + '<br>' +
                        'CNV: ' + d.CNV + '<br>' + 
                        'Ploidy: ' + d.Ploidy
                    )
                    div.style("left", (d3.event.pageX + 10) + "px")
                    div.style("top", (d3.event.pageY + 15) + "px")
                    div.style('opacity','0.9')
                    div.style('background', 'gray')
                    d3.select(this)
                        .attr('stroke','black')
                        .attr('stroke-width', '2px')
                })
                .on('mouseout', function(){
                    d3.select(this)
                        .attr('stroke','none')
                    div.style('opacity','0')
                })

            //draw var square
            variant.append('rect')
                .attr('class', function(d){return d.Sample + " VAR COL"})
                .attr('width',y(cellWidth))
                .attr('height',y(cellHeight/2))
                .attr('fill',function(d){return getVARColor(d.Impact)})
                .attr('x', function(d){return (y(cellWidth) + cellPadding) * samples.indexOf(d.Sample)})
                .attr('y', y(cellHeight/4))
                .attr('pointer-events', function(d){
                    if (d.Impact == 'MODERATE' || d.Impact == 'HIGH'){
                        return 'all'
                    }
                    else {
                        return 'none'
                    }
                })
                .on('mouseover', function(d){
                    if (d.Impact == 'MODERATE' || d.Impact == 'HIGH'){
                        div.html(
                            'Gene: ' + d.Gene + '<br>' +
                            'Impact: ' + d.Impact
                        )
                        div.style("left", (d3.event.pageX + 10) + "px")
                        div.style("top", (d3.event.pageY + 15) + "px")
                        div.style('opacity','0.9')
                        div.style('background', 'gray')
                    }
                    d3.select(this)
                        .attr('stroke','black')
                        .attr('stroke-width', '2px')
                })
                .on('mouseout', function(){
                    d3.select(this)
                        .attr('stroke','none')
                    div.style('opacity','0')
                })
        }
        
        function colorMetadata(key,metadata){
            var metaValues = []
            metadata.forEach(function(d){metaValues.push(d[key])})
            //console.log(metaValues)
            //check if metadata is numerical
            if(!metaValues.some(isNaN)){
                //if numerical, get range
                metaValues = metaValues.map(Number);        
                var hue = Math.floor(Math.random()*360)
                var hsl_high = d3.color('hsl('+hue+',90%,15%)')
                var hsl_low = d3.color('hsl('+hue+',90%,80%)')
                var outputScale = d3.scaleLinear().range([hsl_low.toString(),hsl_high.toString()]).domain([Math.min(...metaValues),Math.max(...metaValues)])
                return outputScale
            }
            else {
                //if not numerical, make range with unique list of variables, assign n random colors to?
                uniqValues = [...new Set(metaValues)]
                colorRange = []
                var saturation = Math.floor(Math.random()*70)
                var lightness = Math.floor(Math.random()*60)
                for(i in uniqValues){
                    //var hue = Math.floor(Math.random()*360)
                    var hue = (360/uniqValues.length) * i
                    colorRange.push('hsl(' + hue + ',' + (30 + saturation) +'%,' + (20 + lightness) + '%)')
                }
                
                if(uniqValues.includes("")){
                    colorRange[uniqValues.indexOf("")] = 'white'
                }
                else{
                    uniqValues.push('')
                    colorRange.push('white')
                }
                //console.log(colorRange)
                return d3.scaleOrdinal().range(colorRange).domain(uniqValues)
                
            }
        }
        
        function arraysEqual(a, b) {
          if (a === b) return true;
          if (a == null || b == null) return false;
          if (a.length !== b.length) return false;

          for (var i = 0; i < a.length; ++i) {
            if (a[i] !== b[i]) return false;
          }
          return true;
        }
        
        //start drawing actual data
        Promise.all([d3.tsv("oncomatrix.txt"), d3.tsv("metadata.txt")]).then(function(d){
            var data = d[0]
            var metadata = d[1]
            
            console.log(data)
            console.log(metadata)
            
            var geneList = [...new Set(data.map(a => a.Gene))]
            var samples = [...new Set(data.map(a => a.Sample))]
            var metaList = Object.keys(metadata[0])
            
            var cgcGeneList = ["A1CF","ABI1","ABL1","ABL2","ACKR3","ACSL3","ACSL6","ACVR1","ACVR2A","AFF1","AFF3","AFF4","AKAP9","AKT1","AKT2","AKT3","ALDH2","ALK","AMER1","ANK1","APC","APOBEC3B","AR","ARAF","ARHGAP26","ARHGAP5","ARHGEF10","ARHGEF10L","ARHGEF12","ARID1A","ARID1B","ARID2","ARNT","ASPSCR1","ASXL1","ASXL2","ATF1","ATIC","ATM","ATP1A1","ATP2B3","ATR","ATRX","AXIN1","AXIN2","B2M","BAP1","BARD1","BAX","BAZ1A","BCL10","BCL11A","BCL11B","BCL2","BCL2L12","BCL3","BCL6","BCL7A","BCL9","BCL9L","BCLAF1","BCOR","BCORL1","BCR","BIRC3","BIRC6","BLM","BMP5","BMPR1A","BRAF","BRCA1","BRCA2","BRD3","BRD4","BRIP1","BTG1","BTK","BUB1B","C15orf65","C2orf44","CACNA1D","CALR","CAMTA1","CANT1","CARD11","CARS","CASC5","CASP3","CASP8","CASP9","CBFA2T3","CBFB","CBL","CBLB","CBLC","CCDC6","CCNB1IP1","CCNC","CCND1","CCND2","CCND3","CCNE1","CCR4","CCR7","CD209","CD274","CD28","CD74","CD79A","CD79B","CDC73","CDH1","CDH10","CDH11","CDH17","CDK12","CDK4","CDK6","CDKN1A","CDKN1B","CDKN2A","CDKN2C","CDX2","CEBPA","CEP89","CHCHD7","CHD2","CHD4","CHEK2","CHIC2","CHST11","CIC","CIITA","CLIP1","CLP1","CLTC","CLTCL1","CNBD1","CNBP","CNOT3","CNTNAP2","CNTRL","COL1A1","COL2A1","COL3A1","COX6C","CPEB3","CREB1","CREB3L1","CREB3L2","CREBBP","CRLF2","CRNKL1","CRTC1","CRTC3","CSF1R","CSF3R","CSMD3","CTCF","CTNNA2","CTNNB1","CTNND1","CTNND2","CUL3","CUX1","CXCR4","CYLD","CYP2C8","CYSLTR2","DAXX","DCAF12L2","DCC","DCTN1","DDB2","DDIT3","DDR2","DDX10","DDX3X","DDX5","DDX6","DEK","DGCR8","DICER1","DNAJB1","DNM2","DNMT3A","DROSHA","DUX4L1","EBF1","ECT2L","EED","EGFR","EIF1AX","EIF3E","EIF4A2","ELF3","ELF4","ELK4","ELL","ELN","EML4","EP300","EPAS1","EPHA3","EPHA7","EPS15","ERBB2","ERBB3","ERBB4","ERC1","ERCC2","ERCC3","ERCC4","ERCC5","ERG","ESR1","ETNK1","ETV1","ETV4","ETV5","ETV6","EWSR1","EXT1","EXT2","EZH2","EZR","FAM131B","FAM135B","FAM46C","FAM47C","FANCA","FANCC","FANCD2","FANCE","FANCF","FANCG","FAS","FAT1","FAT3","FAT4","FBLN2","FBXO11","FBXW7","FCGR2B","FCRL4","FEN1","FES","FEV","FGFR1","FGFR1OP","FGFR2","FGFR3","FGFR4","FH","FHIT","FIP1L1","FKBP9","FLCN","FLI1","FLNA","FLT3","FLT4","FNBP1","FOXA1","FOXL2","FOXO1","FOXO3","FOXO4","FOXP1","FOXR1","FSTL3","FUBP1","FUS","GAS7","GATA1","GATA2","GATA3","GLI1","GMPS","GNA11","GNAQ","GNAS","GOLGA5","GOPC","GPC3","GPC5","GPHN","GRIN2A","GRM3","H3F3A","H3F3B","HERPUD1","HEY1","HIF1A","HIP1","HIST1H3B","HIST1H4I","HLA-A","HLF","HMGA1","HMGA2","HMGN2P46","HNF1A","HNRNPA2B1","HOOK3","HOXA11","HOXA13","HOXA9","HOXC11","HOXC13","HOXD11","HOXD13","HRAS","HSP90AA1","HSP90AB1","ID3","IDH1","IDH2","IGF2BP2","IGH","IGK","IGL","IKBKB","IKZF1","IL2","IL21R","IL6ST","IL7R","IRF4","IRS4","ISX","ITGAV","ITK","JAK1","JAK2","JAK3","JAZF1","JUN","KAT6A","KAT6B","KAT7","KCNJ5","KDM5A","KDM5C","KDM6A","KDR","KDSR","KEAP1","KIAA1549","KIAA1598","KIF5B","KIT","KLF4","KLF6","KLK2","KMT2A","KMT2C","KMT2D","KNSTRN","KRAS","KTN1","LARP4B","LASP1","LCK","LCP1","LEF1","LEPROTL1","LHFP","LIFR","LMNA","LMO1","LMO2","LPP","LRIG3","LRP1B","LSM14A","LYL1","LZTR1","MAF","MAFB","MALAT1","MALT1","MAML2","MAP2K1","MAP2K2","MAP2K4","MAP3K1","MAP3K13","MAPK1","MAX","MB21D2","MDM2","MDM4","MDS2","MECOM","MED12","MEN1","MET","MGMT","MITF","MKL1","MLF1","MLH1","MLLT1","MLLT10","MLLT11","MLLT3","MLLT4","MLLT6","MN1","MNX1","MPL","MSH2","MSH6","MSI2","MSN","MTCP1","MTOR","MUC1","MUC16","MUC4","MUTYH","MYB","MYC","MYCL","MYCN","MYD88","MYH11","MYH9","MYO5A","MYOD1","N4BP2","NAB2","NACA","NBEA","NBN","NCKIPSD","NCOA1","NCOA2","NCOA4","NCOR1","NCOR2","NDRG1","NF1","NF2","NFATC2","NFE2L2","NFIB","NFKB2","NFKBIE","NIN","NKX2-1","NONO","NOTCH1","NOTCH2","NPM1","NR4A3","NRAS","NRG1","NSD1","NT5C2","NTHL1","NTRK1","NTRK3","NUMA1","NUP214","NUP98","NUTM1","NUTM2A","NUTM2B","OLIG2","OMD","P2RY8","PABPC1","PAFAH1B2","PALB2","PAX3","PAX5","PAX7","PAX8","PBRM1","PBX1","PCBP1","PCM1","PDCD1LG2","PDE4DIP","PDGFB","PDGFRA","PDGFRB","PER1","PHF6","PHOX2B","PICALM","PIK3CA","PIK3CB","PIK3R1","PIM1","PLAG1","PLCG1","PML","PMS1","PMS2","POLD1","POLE","POLG","POLQ","POT1","POU2AF1","POU5F1","PPARG","PPFIBP1","PPM1D","PPP2R1A","PPP6C","PRCC","PRDM1","PRDM16","PRDM2","PREX2","PRF1","PRKACA","PRKAR1A","PRKCB","PRPF40B","PRRX1","PSIP1","PTCH1","PTEN","PTK6","PTPN11","PTPN13","PTPN6","PTPRB","PTPRC","PTPRD","PTPRK","PTPRT","PWWP2A","QKI","RABEP1","RAC1","RAD17","RAD21","RAD51B","RAF1","RALGDS","RANBP2","RAP1GDS1","RARA","RB1","RBM10","RBM15","RECQL4","REL","RET","RFWD3","RGPD3","RGS7","RHOA","RHOH","RMI2","RNF213","RNF43","ROBO2","ROS1","RPL10","RPL22","RPL5","RPN1","RSPO2","RSPO3","RUNDC2A","RUNX1","RUNX1T1","S100A7","SALL4","SBDS","SDC4","SDHA","SDHAF2","SDHB","SDHC","SDHD","SEPT5","SEPT6","SEPT9","SET","SETBP1","SETD1B","SETD2","SF3B1","SFPQ","SFRP4","SGK1","SH2B3","SH3GL1","SIRPA","SIX1","SIX2","SKI","SLC34A2","SLC45A3","SMAD2","SMAD3","SMAD4","SMARCA4","SMARCB1","SMARCD1","SMARCE1","SMC1A","SMO","SND1","SOCS1","SOX2","SOX21","SPECC1","SPEN","SPOP","SRC","SRGAP3","SRSF2","SRSF3","SS18","SS18L1","SSX1","SSX2","SSX4","STAG1","STAG2","STAT3","STAT5B","STAT6","STIL","STK11","STRN","SUFU","SUZ12","SYK","TAF15","TAL1","TAL2","TBL1XR1","TBX3","TCEA1","TCF12","TCF3","TCF7L2","TCL1A","TEC","TERT","TET1","TET2","TFE3","TFEB","TFG","TFPT","TFRC","TGFBR2","THRAP3","TLX1","TLX3","TMEM127","TMPRSS2","TNC","TNFAIP3","TNFRSF14","TNFRSF17","TOP1","TP53","TP63","TPM3","TPM4","TPR","TRA","TRAF7","TRB","TRD","TRIM24","TRIM27","TRIM33","TRIP11","TRRAP","TSC1","TSC2","TSHR","U2AF1","UBR5","USP44","USP6","USP8","VAV1","VHL","VTI1A","WAS","WHSC1","WHSC1L1","WIF1","WNK2","WRN","WT1","WWTR1","XPA","XPC","XPO1","YWHAE","ZBTB16","ZCCHC8","ZEB1","ZFHX3","ZMYM3","ZNF198","ZNF278","ZNF331","ZNF384","ZNF429","ZNF479","ZNF521","ZNRF3","ZRSR2"]
            
            if(metaList.includes('Ploidy')){
                console.log("Metadata includes ploidy.")
            } else {
                console.log("ERROR: metadata does not include 'Ploidy' (case sensitive)")
            }
            //make metadata array for if metadata.txt is missing
            //cannot asynchronously read two files. an empty metadata.txt file will have to be generated with preprocessing
            /*
            var metadata = []
            for(i in samples){
                metadata.push({'Sample': samples[i], 'Ploidy': 2})
            }*/
            
            
            console.log("Ranking Genes...")
            var rankList = rankGenes(data, cgcGeneList, metadata)

            //filter data to top 30 ranked
            var topList = rankList.slice(0,30)
            var genes = topList.map(a => a.gene)
            var filteredData = []
            for(i in topList){
                filteredData = filteredData.concat(data.filter(function(f){return f.Gene == topList[i].gene}))
            }
            
            //rank and sort samples based on current gene selection
            samples = rankSamples(samples, filteredData, metadata, genes)

            var longestGene = Math.max(...(genes.map(a => a.length)))
            yAxisWidth = yAxistextSize * (longestGene + 5)
            
            xaxis = svg.append('g')
                .attr('class','xaxis')
                .attr('transform', 'translate(0,'+(((y(cellHeight) + cellPadding) * topList.length) + ((y(metadataHeight) + cellPadding) * metaList.length)) +")")
            yaxis = svg.append('g')
                .attr('class','yaxis')
            
            //function to add gene to y axis
            function addGene(geneToAdd, index){
                var gene = yaxis.append('g')
                    .attr('class', geneToAdd)
                    .attr('transform', function(d){
                        return 'translate(' + y(yAxisWidth) + ',' + (y(cellHeight) + cellPadding) * index + ')'
                    })
                
                for (var i in samples){
                    gene.append('rect')
                        .attr('class', samples[i] + ' background COL')
                        .attr('width',y(cellWidth))
                        .attr('height',y(cellHeight))
                        .attr('fill', 'lightgray')
                        .attr('x', function(d){return (y(cellWidth) + cellPadding) * i})
                }
                gene.append('text')
                    .text(geneToAdd)
                    .attr('id',geneToAdd)
                    .attr('dx', x(-20))
                    .attr('dy', y(cellHeight/2 + 5))
                    .attr('text-anchor', 'end')
                    .attr('font-size',scale(yAxistextSize))
                    .on('click', function(d){
                        //show the x 
                        //console.log(this.id)
                        d3.selectAll(".removeGeneButton")
                            .attr('opacity', 0)
                        d3.selectAll("#"+this.id+"_X")
                            .attr('opacity', 1)
                            .attr("pointer-events", "all")
                    })

                //click to remove gene
                gene.append('svg:foreignObject')
                    .attr('height', '30px')
                    .attr('width', '15px')
                    .attr('class','removeGeneButton')
                    .attr('id', geneToAdd + "_X")
                    .html('<i class="fa fa-times"></i>')
                    .attr('x', x(-18))
                    .attr('y', y(-5 ) )
                    .attr('fill','red')
                    .attr('opacity', 0)
                    .attr("pointer-events", "none")
                    .on('click', function(d){
                        //remove the gene
                        geneToRemove = this.id.slice(0,-2)
                        console.log("Removing " + geneToRemove)
                        removeIndex = genes.indexOf(geneToRemove)
                        if (removeIndex > -1){
                            genes.splice(genes.indexOf(geneToRemove),1) //remove from gene list
                            topList =  topList.filter(function(obj){ //remove from topList
                                return obj.gene != geneToRemove
                            })
                            filteredData = filteredData.filter(function(f){return f.Gene != geneToRemove})
                            //console.log(filteredData)
                            //rerank samples if not locked
                            if(document.getElementById("groupByList").value == 'Sample'){
                                samples = rankSamples(samples, filteredData, metadata, genes)
                            }
                            //console.log(sampleRankList)
                            
                            //redraw positions
                            readjustPos(genes, samples, metaList)
                            d3.selectAll('.' + geneToRemove).remove()
                        }
                    })
            }
            function reSort(groupByValue, sortByValue){
                console.log("grouping by... " + groupByValue + " on... " + sortByValue)
                if(groupByValue == 'Sample'){
                    //sort by default
                    samples = rankSamples(samples,filteredData, metadata, genes)
                    readjustPos(genes, samples, metaList)
                }
                else if(groupByValue == 'Custom'){
                    //do nothing
                }
                else{
                    var metaKey = []
                    metadata.forEach(function(d){metaKey.push({sample: d.Sample, value: d[groupByValue]})})
                    var metaValues = metaKey.map(a => a.value)
                    //check if metadata values are not numerical
                    if(metaValues.some(isNaN)){
                        uniqValues = [...new Set(metaValues)]
			console.log(uniqValues)
                        sampleOrder = []
                        for(i in uniqValues){
                            var groupOrder = []
                            var groupScore = BigInt(0)
                            groupData = metaKey.filter(function(f){
                                return f.value == uniqValues[i]
                            })
                            //console.log(sampleData)
                            for(j in groupData){
                                sampleData = filteredData.filter(function(f){
                                    return f.Sample == groupData[j].sample 
                                })
                                var sampleScore = rankSampleSubset(sampleData,metadata,thresh_highamp,thresh_amp,thresh_del,thresh_deepdel, genes)
                                groupOrder.push({sample: groupData[j].sample , group: uniqValues[i], score: sampleScore})
                                if(sortByValue == 'max'){
				    if(groupScore < sampleScore){
					groupScore = sampleScore
                                    }
                                }
                                else if(sortByValue == 'avg'){
                                    groupScore = groupScore + sampleScore
                                }
                                else{
                                    //should never happpen
                                    console.log("error")
                                }
                            }
                            if(sortByValue == 'avg'){
                                groupScore = groupScore / BigInt(groupData.length)
                            }
                            groupOrder = groupOrder.map(a => ({...a, groupScore: groupScore}))
                            sampleOrder = sampleOrder.concat(groupOrder)
                        }
                        sampleOrder.sort(function(a,b){
			    if(b.groupScore > a.groupScore){
				return 1
			    }
			    else if(b.groupScore == a.groupScore){
				if(b.score > a.score){
				    return 1
				}
			    }
			    else {
				return -1
			    }
			})
                        console.log(sampleOrder)
			samples = sampleOrder.map(a => a.sample)  
                        readjustPos(genes, samples, metaList)
                    }
                    //if metadata values are numerical
                    else{
                        metadata.sort((a, b) => (a[groupByValue] < b[groupByValue]) ? 1 : -1)
                        samples = metadata.map(a => a.Sample)
                    }
                    readjustPos(genes, samples, metaList)
                }
            }
            
            //add x axis
            for (var i in samples){
                xaxis.append('text')
                    .text(samples[i])
                    .attr('id', samples[i] +"_label")
                    .attr('class', samples[i])
                    .attr('x', (y(cellWidth) + cellPadding) * i)
                    .attr('dx',y(yAxisWidth))
                    .attr('dy',y(10))
                    .attr('text-anchor', 'start')
                    .attr('transform','rotate(45,' + ((y(cellWidth) + cellPadding) * i + y(yAxisWidth) )+ ',' + y(10)+ ')')
                    .attr('font-size',scale(xAxistextSize))
            }
            //add y axis
            for (var j in genes){
                addGene(genes[j], j)
            }
            
            //add variants to chart
            addVariants(filteredData,genes,samples,metadata)
            
            //add legend to chart
            var legend = svg.append('g')
                .attr('class','legend')
                .attr('transform', 'translate(' + ((y(cellWidth) + cellPadding) * (samples.length + 2)+ y(yAxisWidth)) + ",0)" )
            
            legend.selectAll('.legendAttrRect')
                .data(attr)
                .enter()
                .append('rect')
                .attr('width',y(cellWidth))
                .attr('height',y(cellHeight/2))
                .attr('fill',function(d){
                    return colorScale(d)
                })
                .attr('y', function(d,i){return (y(cellHeight/2) + (cellPadding*2)) * i})
            
            legend.selectAll('.legendAttrText')
                .data(attr)
                .enter()
                .append('text')
                .text(function(d){return d})
                .attr('font-size',scale(yAxistextSize))
                .attr('x', y(cellWidth) + cellPadding)
                .attr('y', function(d,i){return (y(cellHeight/2) + (cellPadding*2)) * i})
                .attr('dy', scale(yAxistextSize))
            
            //add metadata to chart
            var metaTracks = svg.append('g')
                .attr('class','metadata')
                .attr('transform', function(d){
                    return 'translate(' + y(yAxisWidth) + ',' + ((y(cellHeight) + cellPadding) * genes.length) + ')'
                })
            
            var metaTrack = metaTracks.selectAll('.metadata')
                .data(metadata).enter()
                .append('g')
            
            var metaLegendOffset = (y(cellHeight/2) + (cellPadding*2)) * 7
            for (i in metaList){
                if(metaList[i] != 'Sample'){
                    //generate colorscale for meta value
                    metaColorScale = colorMetadata(metaList[i], metadata)
                    //for each sample, draw squares for each meta value
                    metaTrack.append('rect')
                        .attr('class',function(d){return d.Sample + " COL"})
                        .attr('id', metaList[i])
                        .attr('width',y(cellWidth))
                        .attr('height',y(cellHeight/2))
                        .attr('fill',function(d){
                            return metaColorScale(d[metaList[i]])
                        })
                        .attr('x', function(d){return (y(cellWidth) + cellPadding) * samples.indexOf(d.Sample)})
                        .attr('y', (y(metadataHeight) + cellPadding) * i)
                        .attr('pointer-events', function(d){
                            if (d[this.id] != ''){
                                return 'all'
                            }
                            else {
                                return 'none'
                            }
                        })
                        .on('mouseover', function(d){
                            //console.log(d)
                            div.html(
                                this.id + ': ' + d[this.id]
                            )
                            div.style("left", (d3.event.pageX + 10) + "px")
                            div.style("top", (d3.event.pageY + 15) + "px")
                            div.style('opacity','0.9')
                            div.style('background', 'gray')
                            d3.select(this)
                                .attr('stroke','black')
                                .attr('stroke-width', '2px')
                        })
                        .on('mouseout', function(){
                            d3.select(this)
                                .attr('stroke','none')
                            div.style('opacity','0')
                        })
                    //append label
                    metaTracks.append('text')
                        .text(metaList[i])
                        .attr('dx', x(-20))
                        .attr('dy', y(metadataHeight/2 + 5))
                        .attr('text-anchor', 'end')
                        .attr('y', (y(metadataHeight) + cellPadding) * i)
                        .attr('font-size',scale(yAxistextSize))
                    
                    var metaValues = metadata.map(a => a[metaList[i]])
                    
                    
                    if(!metaValues.some(isNaN)){
                        legend.append('text')
                            .text(metaList[i])
                            .attr('font-size',scale(yAxistextSize))
                            .attr('font-weight', 'bold')
                            .attr('y', function(d){return (y(cellHeight/2) + (cellPadding*2)) + metaLegendOffset})
                            .attr('dy', scale(-5))
                        metaLegendOffset =  (y(cellHeight/2) + (cellPadding*2)) + metaLegendOffset
                        
                        legendArray = []
                        for(j=Math.min(...metaValues); j <= Math.max(...metaValues); j = ((Math.max(...metaValues) - Math.min(...metaValues))/5)+j ){
                            legendArray.push(j)
                        }
                         
                        for(j=0; j < 5; j++){
                            legend.append('rect')
                                .attr('width',y(cellWidth))
                                .attr('height',y(cellHeight/2))
                                .attr('fill',function(d){
                                    return metaColorScale(legendArray[j])
                                })
                                .attr('x', function(d){return y(cellWidth) * j})
                                .attr('y', function(d){return metaLegendOffset})    
                        }
                        legend.append('text')
                            .text(Math.min(...metaValues))
                            .attr('font-size',scale(yAxistextSize))
                            .attr('text-anchor', 'middle')
                            .attr('y', function(d){return (y(cellHeight/2) + (cellPadding*2)) + metaLegendOffset})
                            .attr('dy', scale(yAxistextSize)/2)
                        
                        legend.append('text')
                            .text(Math.max(...metaValues))
                            .attr('font-size',scale(yAxistextSize))
                            .attr('text-anchor', 'middle')
                            .attr('x', function(d){return y(cellWidth) * 5})
                            .attr('y', function(d){return (y(cellHeight/2) + (cellPadding*2)) + metaLegendOffset})
                            .attr('dy', scale(yAxistextSize)/2)
                        
                        metaLegendOffset =  (y(cellHeight/2) + (cellPadding*2)) * 2 + metaLegendOffset
                        
                    }
                    else{
                        var uniqValues = [...new Set(metaValues)]
                        if(uniqValues.includes('')){
                            uniqValues.splice(uniqValues.indexOf(''),1)
                        }
                        legend.append('text')
                            .text(metaList[i])
                            .attr('font-size',scale(yAxistextSize))
                            .attr('font-weight', 'bold')
                            .attr('y', function(d){return (y(cellHeight/2) + (cellPadding*2)) + metaLegendOffset})
                            .attr('dy', scale(-5))
                        
                        metaLegendOffset =  (y(cellHeight/2) + (cellPadding*2)) + metaLegendOffset
                        
                        for(j in uniqValues){
                            legend.append('rect')
                                .attr('width',y(cellWidth))
                                .attr('height',y(cellHeight/2))
                                .attr('fill',function(d){
                                    return metaColorScale(uniqValues[j])
                                })
                                .attr('y', function(d){return (y(cellHeight/2) + (cellPadding*2)) * j + metaLegendOffset})

                            legend.append('text')
                                .text(uniqValues[j])
                                .attr('font-size',scale(yAxistextSize))
                                .attr('x', y(cellWidth) + cellPadding)
                                .attr('y', function(d){return (y(cellHeight/2) + (cellPadding*2)) * j + metaLegendOffset})
                                .attr('dy', scale(yAxistextSize))
                        }
                        metaLegendOffset =  (y(cellHeight/2) + (cellPadding*2)) * (uniqValues.length + 1) + metaLegendOffset
                    }
                }
                groupBy.append('option')
                    .attr('value',metaList[i])
                    .text(metaList[i])
            }
            groupBy.append('option')
                .attr('value', 'Custom')
                .text('Custom')
            
            //add gene code
            var addGeneList = d3.select('#addGeneList')
            var addGeneInput = d3.select('#addGeneInput')
            var addGeneButton = d3.select('#addGeneButton')
            
            addGeneInput.on("keyup", function(d){
                addGeneList.html(null) //remove old list
                geneStartsWith = geneList.filter((gene) => gene.startsWith(this.value))

                if(geneStartsWith.length == 0){
                    d3.select('#no_variants_error').style('opacity',1)
                }
                else if(geneStartsWith.length <= 20){ //if list less than 20, show list
                    d3.select('#no_variants_error').style('opacity',0)
                    for(var i in geneStartsWith){
                        addGeneList.append('option')
                            .text(geneStartsWith[i])
                    }
                }
                else{
                    d3.select('#no_variants_error').style('opacity',0)
                }
            })
            addGeneButton.on('click', function(d){
                geneToAdd = document.getElementById("addGeneInput").value
                document.getElementById("addGeneInput").value = ""
                if(geneList.includes(geneToAdd) && !genes.includes(geneToAdd)){
                    console.log("Adding " + geneToAdd)
                    geneData = data.filter(function(f){
                        return f.Gene == geneToAdd
                    })
                    geneRank = {gene: geneToAdd, score: rankGeneSubset(geneData,metadata,thresh_highamp,thresh_amp,thresh_del,thresh_deepdel)}
                    //add to toplist
                    topList.push(geneRank)
                    topList.sort(function(a,b){return b.score - a.score})
                    //add to genelist
                    console.log(topList)
                    genes = topList.map(a => a.gene)
                    //get filteredData again
                    filteredData = []
                    for(i in topList){
                        filteredData = filteredData.concat(data.filter(function(f){return f.Gene == topList[i].gene}))
                    }
                    //rerank samples
                    if(document.getElementById("groupByList").value == 'Sample'){
                        samples = rankSamples(samples,filteredData, metadata, genes)
                    }
                    //add gene to yaxis
                    addGene(geneToAdd, genes.length)
                    //add variants
                    addVariants(geneData, genes, samples, metadata)
                    //redraw positions
                    readjustPos(genes, samples, metaList)
                }
                else{
                    console.log("Gene missing or already in oncoprint")
                    
                }
                
            })
            
            //readjust threshold code 
            var readjustThreshold = d3.select('#readjustThreshold')
            
            //on click of button
            readjustThreshold.on('click',function(d){
                console.log("Readjusting thresholds...")
                thresh_highamp = document.getElementById("high_amp_adjust").value
                thresh_amp = document.getElementById("amp_adjust").value
                thresh_del = document.getElementById("del_adjust").value
                thresh_deepdel = document.getElementById("deep_del_adjust").value
                //rerank current genes
                console.log("Ranking Genes...")
                topList = rankGenes(filteredData, genes, metadata)
                //reorder genes in list
                genes = topList.map(a => a.gene)
                //rerank samples
                if(document.getElementById("groupByList").value == 'Sample'){
                    samples = rankSamples(samples,filteredData, metadata, genes)
                }
                //recolor cnvs of current genes
                d3.selectAll('.CNV')
                    .attr('fill',function(d){
                        var ploidy = metadata.filter(function(f){return f.Sample == d.Sample})[0].Ploidy
                        return getCNVColor(d.CNV, ploidy)
                    })
                readjustPos(genes, samples, metaList)
            })
            
            //groupBy code
            groupBy.on('change',function(d){
                reSort(this.value, document.getElementById('sortByList').value)
            })
            sortBy.on('change',function(d){
                reSort(document.getElementById('groupByList').value, this.value )
            })
            
            function cPosition(d) {
                var v = dragging[d.sample];
                return v == null ? d.x : v;
            }
            var dragging = []
            var draggedSample
            var positions = []
            
            //drag behavior code
            d3.selectAll(".COL")
                .call(d3.drag()
                .subject(function() { 
                    var t = d3.select(this);
                    return {sample: t.attr("class").split(" ")[0], x: t.attr("x")};
                })
                .on("start", function(d) {
                    console.log('drag started')
                    draggedSample = d3.event.subject.sample
                    for(i in samples){
                        positions.push({sample: samples[i], x: (y(cellWidth) + cellPadding) * i})
                    }

                })
                .on("drag", function(d) {
                    d3.selectAll("." + draggedSample).attr("x", d3.event.x)
                    d3.selectAll('#' + draggedSample + "_label")
                        .attr('transform','rotate(45,' + (d3.event.x + y(yAxisWidth) )+ ',' + y(10)+ ')')
                    dragging[draggedSample] = d3.event.x
                    dragsamples = positions.sort(function(a,b){ return cPosition(a) - cPosition(b)}).map(a => a.sample)
                    if(!arraysEqual(samples, dragsamples)){
                        //change groupBy value to Custom
                        groupBy.property('value','Custom')
                        //resort based on new order
                        samples = dragsamples 
                        readjustPos(genes, samples, metaList)
                    }
                })
                .on("end", function(d) {
                    console.log('drag ended')
                    positions = []
                    delete dragging[draggedSample]
                    readjustPos(genes, samples, metaList)
                })  
                )
        })
    </script>
  </body>
</html>
