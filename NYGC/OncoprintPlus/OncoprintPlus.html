<!DOCTYPE html>
<html>    
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.css">
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
    <style>
        #chart {
            position: fixed;
            left: 0px;
            right: 0px;
            top: 0px;
            bottom: 0px;
            z-index: -2;
            height: 100%;
        }
        #options{
            margin-bottom:10px; 
            border-radius: 5px;
            padding: 10px;
            background-color: #FFEFD5;
        }
        body {
            font-family: sans-serif
        }
        div.tooltip {
            position: absolute;
            text-align: left;
            width: auto;
            height: auto;
            padding: 5px;
            border-width: 1px;
            border-radius: 2px;
            pointer-events: none;
            font-family: sans-serif;
            font-size: 13px;
            border: 2px solid white;
        }
        input{
            margin-bottom: 0.5rem;
            height: 25px !important;
        }
        button{
            padding-left: 10px;
            padding-right: 10px;
            background-color: white;
        }
    
    </style>
  </head>
  <body>
    <div id="options" class="row">
        <div class="three columns">
            <div class="row">
                <b>Add Gene:</b>
                <br>
                <input list="addGeneList" placeholder="e.g. TP53" id='addGeneInput'>
                <datalist id="addGeneList">
                </datalist>
                <button type="button" id="addGeneButton">Add</button>
            </div>
            <div class="row">
                <b>Sort by:</b>
                <br>
                <select id="sortByList">
                </select>
            </div>
        </div>
        <div class="four columns">
            <div><b>Adjust CNV Thresholds:</b></div>
            <div style="padding-left: 20px" class="row">
                <div class="four columns">HIGH AMP:</div> 
                <input class="four columns" type="number" id="high_amp_adjust" value=2 step=".01"></div>
            <div style="padding-left: 20px" class="row">
                <div class="four columns">AMP:</div>  
                <input class="four columns" type="number" id="amp_adjust" value=1 step=".01"></div>
            <div style="padding-left: 20px" class="row">
                <div class="four columns">DEL:</div>  
                <input class="four columns" type="number" id="del_adjust" value=-1 step=".01"></div>
            <div style="padding-left: 20px" class="row">
                <div class="four columns">DEEP DEL:</div>  
                <input class="four columns" type="number" id="deep_del_adjust" value=-2 step=".01"></div>
            <button type="button" id="readjustThreshold" class="row">Readjust</button>
        </div>
    </div>
    <div id="chart">
    </div>
    
    <script>
        var chartDiv = document.getElementById("chart");
        var width = chartDiv.clientWidth -20;
        var height = chartDiv.clientHeight -20;

        var x = d3.scaleLinear().range([0,width]).domain([0,1000])
        var y = d3.scaleLinear().range([0,height-150]).domain([0,1000])
        var scale = d3.scaleLinear().range([0,height]).domain([0,1000])
        
        var attr = ['HIGH','MODERATE','HIGH AMP','AMP','DEL','DEEP DEL']
        var attrColors = ['black','#f8b946','#982f2f','#f85252','#3573fd','#00308b']
        var colorScale = d3.scaleOrdinal().range(attrColors).domain(attr)
        
        var ampColorScale = d3.scaleLinear().range(['white','#982f2f']).domain([0,1])
        var delColorScale = d3.scaleLinear().range(['white','#00308b']).domain([0,-1])
        
        var div = d3.select("body").append("div")
        .attr("class", "tooltip")
        .attr("font-size",scale(60))
        .style("opacity", 0);

        var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", 4000)
        
        var cellWidth = 20
        var cellHeight = 40
        var cellPadding = 2
        var metadataHeight = 20
        var xAxistextSize = 12
        var yAxistextSize = 15
        var yAxisWidth = 10 //by default. will be changed
        var thresh_highamp = 2
        var thresh_amp = 1
        var thresh_del = -1
        var thresh_deepdel = -2
        
        function getCNVColor(cnv, ploidy){
            if(cnv != ''){
                if (cnv - ploidy >= thresh_highamp){
                    return colorScale('HIGH AMP')
                } else if (cnv - ploidy >= thresh_amp){
                    return colorScale('AMP')
                } else if (cnv - ploidy <= thresh_deepdel){
                    return colorScale('DEEP DEL')
                } else if (cnv - ploidy <= thresh_del){
                    return colorScale('DEL')
                } else {
                    return 'rgb(0,0,0,0)'
                }
            }
            else{
                return 'rgb(0,0,0,0)'
            }
            
        }
        
        function getVARColor(impact){
            if (impact == "HIGH"){
                return colorScale('HIGH')
            } else if (impact == "MODERATE"){
                return colorScale('MODERATE')
            } else {
                return 'rgb(0,0,0,0)'
            }
        }
        
        function rank(subset, metadata, thresh_ha, thresh_a, thresh_d, thresh_dd){
            for(i in subset){
                subset[i].Ploidy = metadata.filter(function(f){return f.Sample == subset[i].Sample})[0].Ploidy
            }
            mod_num = subset.filter(function(f){return f.Impact == "MODERATE"}).length
            high_num = subset.filter(function(f){return f.Impact == "HIGH"}).length
            high_amp_num = subset.filter(function(f){return f.CNV-f.Ploidy >= thresh_ha && f.CNV != ""}).length
            amp_num = subset.filter(function(f){return f.CNV-f.Ploidy >= thresh_a && f.CNV-f.Ploidy < thresh_ha && f.CNV != ""}).length
            deep_del_num = subset.filter(function(f){return f.CNV-f.Ploidy <= thresh_dd && f.CNV != ""}).length
            del_num = subset.filter(function(f){return f.CNV-f.Ploidy <= thresh_d && f.CNV-f.Ploidy > thresh_dd && f.CNV != ""}).length

            score = high_num * 20
                + mod_num * 10
                + deep_del_num * 4
                + high_amp_num * 4
                + del_num * 2
                + amp_num * 2
            
            return score
        }
        
        function rankSamples(samples, data, metadata){
            //console.log(metadata)
            sampleRankList = []
            for (i in samples){
                sampleData = data.filter(function(f){
                    return f.Sample == samples[i]
                })
                sampleRankList.push({Sample: samples[i], score: rank(sampleData,metadata,thresh_highamp,thresh_amp,thresh_del,thresh_deepdel)})
            }
            sampleRankList.sort(function(a,b){return b.score - a.score})
            return [...new Set(sampleRankList.map(a => a.Sample))]
        }
        
        function rankGenes(data, geneList, metadata){
            rankList = []
            for (i in geneList){
                geneData = data.filter(function(f){
                    return f.Gene == geneList[i]
                })
                rankList.push({gene: geneList[i], score: rank(geneData,metadata,thresh_highamp,thresh_amp,thresh_del,thresh_deepdel)})
            }
            rankList = rankList.filter(function(f){return f.gene != 'Unknown'})
            
            return rankList.sort(function(a,b){return b.score - a.score})
        }
        
        function readjustPos(genes, samples, metaList){
            for(var i in samples){
                //redraw sample label
                d3.selectAll('#' + samples[i])
                    .attr('x', (y(cellWidth) + cellPadding) * i)
                    .attr('transform','rotate(45,' + ((y(cellWidth) + cellPadding) * i + y(yAxisWidth) )+ ',' + y(10)+ ')')
                //redraw sample variants
                d3.selectAll('.' + samples[i])
                    .attr('x', (y(cellWidth) + cellPadding) * i)
            }
            for(var i in genes){
                d3.selectAll('.' + genes[i])
                    .attr('transform', function(d){
                        return 'translate(' + y(yAxisWidth) + ',' + (y(cellHeight) + cellPadding) * i + ')'
                    })
            }
            d3.selectAll('.xaxis')
                .attr('transform', 'translate(0,'+(((y(cellHeight) + cellPadding) * genes.length) + ((y(metadataHeight) + cellPadding) * metaList.length))+")")
            d3.selectAll('.metadata')
                .attr('transform', function(d){
                    return 'translate(' + y(yAxisWidth) + ',' + ((y(cellHeight) + cellPadding) * genes.length) + ')'
                })
        }
        
        function addVariants(data, genes, samples, metadata){
            variant = svg.selectAll('.variant')
                .data(data).enter()
                .append('g')
                .attr('transform', function(d){
                    return 'translate(' + y(yAxisWidth) + ',' + (y(cellHeight) + cellPadding) * genes.indexOf(d.Gene) + ')'
                })
                .attr('class', function(d){return d.Gene})

            //draw cnv square
            variant.append('rect')
                .attr('class', function(d){return d.Sample + " CNV"})
                .attr('width',y(cellWidth))
                .attr('height',y(cellHeight))
                .attr('fill',function(d){
                    var ploidy = metadata.filter(function(f){return f.Sample == d.Sample})[0].Ploidy
                    return getCNVColor(d.CNV, ploidy)
                })
                .attr('x', function(d){return (y(cellWidth) + cellPadding) * samples.indexOf(d.Sample)})
                .attr('pointer-events', function(d){
                    if (d.CNV != ''){
                        return 'all'
                    }
                    else {
                        return 'none'
                    }
                })
                .on('mouseover', function(d){
                    console.log(d)
                    div.html(
                        'Gene: ' + d.Gene + '<br>' +
                        'CNV: ' + d.CNV + '<br>' + 
                        'Ploidy: ' + d.Ploidy
                    )
                    div.style("left", (d3.event.pageX + 10) + "px")
                    div.style("top", (d3.event.pageY + 15) + "px")
                    div.style('opacity','0.9')
                    div.style('background', 'gray')
                    d3.select(this)
                        .attr('stroke','black')
                        .attr('stroke-width', '2px')
                })
                .on('mouseout', function(){
                    d3.select(this)
                        .attr('stroke','none')
                    div.style('opacity','0')
                })

            //draw var square
            variant.append('rect')
                .attr('class', function(d){return d.Sample + " VAR"})
                .attr('width',y(cellWidth))
                .attr('height',y(cellHeight/2))
                .attr('fill',function(d){return getVARColor(d.Impact)})
                .attr('x', function(d){return (y(cellWidth) + cellPadding) * samples.indexOf(d.Sample)})
                .attr('y', y(cellHeight/4))
                .attr('pointer-events', function(d){
                    if (d.Impact == 'MODERATE' || d.Impact == 'HIGH'){
                        return 'all'
                    }
                    else {
                        return 'none'
                    }
                })
                .on('mouseover', function(d){
                    if (d.Impact == 'MODERATE' || d.Impact == 'HIGH'){
                        div.html(
                            'Gene: ' + d.Gene + '<br>' +
                            'Impact: ' + d.Impact
                        )
                        div.style("left", (d3.event.pageX + 10) + "px")
                        div.style("top", (d3.event.pageY + 15) + "px")
                        div.style('opacity','0.9')
                        div.style('background', 'gray')
                    }
                    d3.select(this)
                        .attr('stroke','black')
                        .attr('stroke-width', '2px')
                })
                .on('mouseout', function(){
                    d3.select(this)
                        .attr('stroke','none')
                    div.style('opacity','0')
                })
        }
        
        function colorMetadata(key,metadata){
            var metaValues = []
            metadata.forEach(function(d){metaValues.push(d[key])})
            //console.log(metaValues)
            //check if metadata is numerical
            if(!metaValues.some(isNaN)){
                //if numerical, get range
                metaValues = metaValues.map(Number);        
                var hue = Math.floor(Math.random()*360)
                var hsl_high = d3.color('hsl('+hue+',90%,15%)')
                var hsl_low = d3.color('hsl('+hue+',90%,80%)')
                var outputScale = d3.scaleLinear().range([hsl_low.toString(),hsl_high.toString()]).domain([Math.min(...metaValues),Math.max(...metaValues)])
                return outputScale
            }
            else {
                //if not numerical, make range with unique list of variables, assign n random colors to?
                uniqValues = [...new Set(metaValues)]
                colorRange = []
                var saturation = Math.floor(Math.random()*70)
                var lightness = Math.floor(Math.random()*60)
                for(i in uniqValues){
                    //var hue = Math.floor(Math.random()*360)
                    var hue = (360/uniqValues.length) * i
                    colorRange.push('hsl(' + hue + ',' + (30 + saturation) +'%,' + (20 + lightness) + '%)')
                }
                
                if(uniqValues.includes("")){
                    colorRange[uniqValues.indexOf("")] = 'white'
                }
                else{
                    uniqValues.push('')
                    colorRange.push('white')
                }
                console.log(colorRange)
                
                return d3.scaleOrdinal().range(colorRange).domain(uniqValues)
                
            }
        }
        
        //start drawing actual data
        Promise.all([d3.tsv("oncomatrix.txt"), d3.tsv("metadata.txt")]).then(function(data){
            var metadata = data[1]
            var data = data[0]
            console.log(data)
            console.log(metadata)
            
            var geneList = [...new Set(data.map(a => a.Gene))]
            var samples = [...new Set(data.map(a => a.Sample))]
            var metaList = Object.keys(metadata[0])
            
            if(metaList.includes('Ploidy')){
                console.log("Metadata includes ploidy.")
            } else {
                console.log("ERROR: metadata does not include 'Ploidy' (case sensitive)")
            }
            //make metadata array for if metadata.txt is missing
            //cannot asynchronously read two files. an empty metadata.txt file will have to be generated with preprocessing
            /*
            var metadata = []
            for(i in samples){
                metadata.push({'Sample': samples[i], 'Ploidy': 2})
            }*/
            
            console.log("Ranking Genes...")
            var rankList = rankGenes(data, geneList, metadata)

            //filter data to top 30 ranked
            var topList = rankList.slice(0,30)
            var filteredData = []
            for(i in topList){
                filteredData = filteredData.concat(data.filter(function(f){return f.Gene == topList[i].gene}))
            }
            
            //rank and sort samples based on current gene selection
            samples = rankSamples(samples, filteredData, metadata)

            var genes = topList.map(a => a.gene)
            var longestGene = Math.max(...(genes.map(el => el.length)))
            yAxisWidth = yAxistextSize * (longestGene + 5)
            
            xaxis = svg.append('g')
                .attr('class','xaxis')
                .attr('transform', 'translate(0,'+(((y(cellHeight) + cellPadding) * topList.length) + ((y(metadataHeight) + cellPadding) * metaList.length)) +")")
            yaxis = svg.append('g')
                .attr('class','yaxis')
            
            //function to add gene to y axis
            function addGene(geneToAdd, index){
                var gene = yaxis.append('g')
                    .attr('class', geneToAdd)
                    .attr('transform', function(d){
                        return 'translate(' + y(yAxisWidth) + ',' + (y(cellHeight) + cellPadding) * index + ')'
                    })
                
                for (var i in samples){
                    gene.append('rect')
                        .attr('class','background')
                        .attr('width',y(cellWidth))
                        .attr('height',y(cellHeight))
                        .attr('fill', 'lightgray')
                        .attr('x', function(d){return (y(cellWidth) + cellPadding) * i})
                }
                gene.append('text')
                    .text(geneToAdd)
                    .attr('id',geneToAdd)
                    .attr('dx', x(-20))
                    .attr('dy', y(cellHeight/2 + 5))
                    .attr('text-anchor', 'end')
                    .attr('font-size',scale(yAxistextSize))
                    .on('click', function(d){
                        //show the x 
                        //console.log(this.id)
                        d3.selectAll(".removeGeneButton")
                            .attr('opacity', 0)
                        d3.selectAll("#"+this.id+"_X")
                            .attr('opacity', 1)
                            .attr("pointer-events", "all")
                    })

                //click to remove gene
                gene.append('svg:foreignObject')
                    .attr('height', '30px')
                    .attr('width', '15px')
                    .attr('class','removeGeneButton')
                    .attr('id', geneToAdd + "_X")
                    .html('<i class="fa fa-times"></i>')
                    .attr('x', x(-18))
                    .attr('y', y(-5 ) )
                    .attr('fill','red')
                    .attr('opacity', 0)
                    .attr("pointer-events", "none")
                    .on('click', function(d){
                        //remove the gene
                        geneToRemove = this.id.slice(0,-2)
                        console.log("Removing " + geneToRemove)
                        removeIndex = genes.indexOf(geneToRemove)
                        if (removeIndex > -1){
                            genes.splice(genes.indexOf(geneToRemove),1) //remove from gene list
                            topList =  topList.filter(function(obj){ //remove from topList
                                return obj.gene != geneToRemove
                            })
                            filteredData = filteredData.filter(function(f){return f.Gene != geneToRemove})
                            //console.log(filteredData)
                            //rerank samples
                            samples = rankSamples(samples, filteredData, metadata)
                            //console.log(sampleRankList)
                            
                            //redraw positions
                            readjustPos(genes, samples, metaList)
                            d3.selectAll('.' + geneToRemove).remove()
                        }
                    })
            }
            
            //add x axis
            for (var i in samples){
                xaxis.append('text')
                    .text(samples[i])
                    .attr('id',samples[i])
                    .attr('x', (y(cellWidth) + cellPadding) * i)
                    .attr('dx',y(yAxisWidth))
                    .attr('dy',y(10))
                    .attr('text-anchor', 'start')
                    .attr('transform','rotate(45,' + ((y(cellWidth) + cellPadding) * i + y(yAxisWidth) )+ ',' + y(10)+ ')')
                    .attr('font-size',scale(xAxistextSize))
            }
            //add y axis
            for (var j in genes){
                addGene(genes[j], j)
            }
            
            //add variants to chart
            addVariants(filteredData,genes,samples,metadata)
            
            //add metadata to chart
            var metaTracks = svg.append('g')
                .attr('class','metadata')
                .attr('transform', function(d){
                    return 'translate(' + y(yAxisWidth) + ',' + ((y(cellHeight) + cellPadding) * genes.length) + ')'
                })
            
            var metaTrack = metaTracks.selectAll('.metadata')
                .data(metadata).enter()
                .append('g')
            
            var sortByList = d3.select('#sortByList')
            for (i in metaList){
                if(metaList[i] != 'Sample'){
                    //generate colorscale for meta value
                    metaColorScale = colorMetadata(metaList[i], metadata)
                    //for each sample, draw squares for each meta value
                    metaTrack.append('rect')
                        .attr('class',function(d){return d.Sample})
                        .attr('id', metaList[i])
                        .attr('width',y(cellWidth))
                        .attr('height',y(cellHeight/2))
                        .attr('fill',function(d){
                            return metaColorScale(d[metaList[i]])
                        })
                        .attr('x', function(d){return (y(cellWidth) + cellPadding) * samples.indexOf(d.Sample)})
                        .attr('y', (y(metadataHeight) + cellPadding) * i)
                        .attr('pointer-events', function(d){
                            if (d[this.id] != ''){
                                return 'all'
                            }
                            else {
                                return 'none'
                            }
                        })
                        .on('mouseover', function(d){
                            console.log(d)
                            div.html(
                                this.id + ': ' + d[this.id]
                            )
                            div.style("left", (d3.event.pageX + 10) + "px")
                            div.style("top", (d3.event.pageY + 15) + "px")
                            div.style('opacity','0.9')
                            div.style('background', 'gray')
                            d3.select(this)
                                .attr('stroke','black')
                                .attr('stroke-width', '2px')
                        })
                        .on('mouseout', function(){
                            d3.select(this)
                                .attr('stroke','none')
                            div.style('opacity','0')
                })
                    
                    
                    //append label
                    metaTracks.append('text')
                        .text(metaList[i])
                        .attr('dx', x(-20))
                        .attr('dy', y(metadataHeight/2 + 5))
                        .attr('text-anchor', 'end')
                        .attr('y', (y(metadataHeight) + cellPadding) * i)
                        .attr('font-size',scale(yAxistextSize))
                }
                sortByList.append('option')
                    .attr('value',metaList[i])
                    .text(metaList[i])
            }
            
    
            
            //add gene code
            var addGeneList = d3.select('#addGeneList')
            var addGeneInput = d3.select('#addGeneInput')
            var addGeneButton = d3.select('#addGeneButton')
            
            addGeneInput.on("keyup", function(d){
                addGeneList.html(null) //remove old list
                geneStartsWith = geneList.filter((gene) => gene.startsWith(this.value))
                if(geneStartsWith.length <= 20){ //if list less than 20, show list
                    for(var i in geneStartsWith){
                        addGeneList.append('option')
                            .text(geneStartsWith[i])
                    }
                }
            })
            addGeneButton.on('click', function(d){
                geneToAdd = document.getElementById("addGeneInput").value
                document.getElementById("addGeneInput").value = ""
                if(geneList.includes(geneToAdd) && !genes.includes(geneToAdd)){
                    console.log("Adding " + geneToAdd)
                    geneRank = rankList.filter(function(f){
                        return f.gene == geneToAdd
                    })
                    geneData = data.filter(function(f){
                        return f.Gene == geneToAdd
                    })
                    //add to toplist
                    topList.push(geneRank[0])
                    topList.sort(function(a,b){return b.score - a.score})
                    //add to genelist
                    genes = topList.map(a => a.gene)
                    //get filteredData again
                    filteredData = []
                    for(i in topList){
                        filteredData = filteredData.concat(data.filter(function(f){return f.Gene == topList[i].gene}))
                    }
                    //rerank samples
                    samples = rankSamples(samples,filteredData, metadata)
                    //add gene to yaxis
                    addGene(geneToAdd, genes.length)
                    //add variants
                    addVariants(geneData, genes, samples, metadata)
                    //redraw positions
                    readjustPos(genes, samples, metaList)
                }
                else{
                    console.log("Gene missing or already in oncoprint")
                    
                }
                
            })
            
            //readjust threshold code 
            var readjustThreshold = d3.select('#readjustThreshold')
            
            //on click of button
            readjustThreshold.on('click',function(d){
                console.log("Readjusting thresholds...")
                thresh_highamp = document.getElementById("high_amp_adjust").value
                thresh_amp = document.getElementById("amp_adjust").value
                thresh_del = document.getElementById("del_adjust").value
                thresh_deepdel = document.getElementById("deep_del_adjust").value
                //rerank current genes
                console.log("Ranking Genes...")
                topList = rankGenes(filteredData, genes, metadata)
                //reorder genes in list
                genes = topList.map(a => a.gene)
                //rerank samples
                samples = rankSamples(samples,filteredData, metadata)
                //recolor cnvs of current genes
                d3.selectAll('.CNV')
                    .attr('fill',function(d){
                        var ploidy = metadata.filter(function(f){return f.Sample == d.Sample})[0].Ploidy
                        return getCNVColor(d.CNV, ploidy)
                    })
                readjustPos(genes, samples, metaList)
            })
            
            //sortBy code
            var sortBy = d3.select('#sortByList')
            
            sortBy.on('change',function(d){
                console.log("sorting by... " + this.value)
                sortValue = this.value
                if(this.value == 'Sample'){
                    //sort by default
                    readjustPos(genes, samples, metaList)
                }
                else{
                    metadata.sort((a, b) => (a[sortValue] < b[sortValue]) ? 1 : -1)
                    sortedSamples = metadata.map(a => a.Sample)
                    readjustPos(genes, sortedSamples, metaList)
                }
                
            })
        })

    </script>
  </body>
</html>
